name: Build and Test Workflow
on: 
  pull_request_target:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      FVT_APIML_ARTIFACT:
        description: 'APIML build for integration test'
        required: true
        default: 'libs-release-local/org/zowe/apiml/sdk/zowe-install/*/zowe-install-*.zip'
      FVT_API_ARTIFACT:
        description: 'Jobs API artifact download pattern'
        required: true
        default: 'libs-snapshot-local/org/zowe/explorer/jobs/*/jobs-api-package-*.zip'
      FVT_ZOSMF_HOST:
        description: 'z/OSMF server for integration test'
        required: true
        default: 'zzow01.zowe.marist.cloud'
      FVT_ZOSMF_PORT:
        description: 'z/OSMF port for integration test'
        required: true
        default: '10443'
      FVT_SERVER_HOSTNAME:
        description: 'Server hostname for integration test'
        required: true
        default: 'fvt-test-server'
      API_ML_DEBUG_PROFILES:
        description: 'Debug profiles for API Gateway'
        required: true
        default: 'default'


jobs:
  check-permission:
    runs-on: macos-latest
    steps:
      # this action will fail the whole workflow if permission check fails
      - name: check permission
        uses: zowe-actions/global-setup/permission-check@main
        with:
            user: ${{ github.actor }}
            github_repo: ${{ github.repository }}
            github_user: ${{ secrets.ZOWE_ROBOT_USER }}
            github_passwd: ${{ secrets.ZOWE_ROBOT_TOKEN }}

  setup-build:
    runs-on: macos-latest
    needs: check-permission
    steps: 
      # Initial setting up environments
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: ${{ env.DEFAULT_NODE_VERSION }}
      - uses: jfrog/setup-jfrog-cli@v1
        env:
          JF_ARTIFACTORY_1: ${{ secrets.JF_ARTIFACTORY_TOKEN }}
      - uses: zowe-actions/global-setup/envvars-global@main
      - uses: zowe-actions/global-setup/generic-setup@main
        # with:
          # extraInit: |
          #   console.log('1234')
          #   console.log('5678')
       
      # Set up NodeJS env
      - name: Nodejs project setup action
        uses: zowe-actions/NodeJS-actions/setup-action@setup
        with:
          packageName: 'org.zowe.explorer-jes'
          nodeJsVersion: 'v10.18.1'
          installRegistry_registry: ${{ env.DEFAULT_NPM_PRIVATE_INSTALL_REGISTRY }}
          installRegistry_email: ${{ secrets.NPM_PRIVATE_REGISTRY_EMAIL }}
          installRegistry_username: ${{ secrets.NPM_PRIVATE_REGISTRY_USERNAME }}
          installRegistry_password: ${{ secrets.NPM_PRIVATE_REGISTRY_PASSWORD }}
          publishRegistry_email: ${{ secrets.NPM_PRIVATE_REGISTRY_EMAIL }}
          publishRegistry_username: ${{ secrets.NPM_PRIVATE_REGISTRY_USERNAME }}
          publishRegistry_password: ${{ secrets.NPM_PRIVATE_REGISTRY_PASSWORD }}

      # Build project
      - name: Nodejs project build action
        uses: zowe-actions/NodeJS-actions/build-action@setup
        with:
          nodeJsVersion: 'v10.18.1'
      
      # to access inputs, call ${{ github.event.inputs.SOMETHING }}